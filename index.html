<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jamaica Multi-Vendor Marketplace</title>
    <link rel="stylesheet" href="css/style.css" />
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <!-- Firebase Configuration & Main Logic -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/main.js" defer></script>
  </head>
  <body>
    <nav>
      <a href="index.html">Home</a>
      <a href="vendor-dashboard.html">Vendor Dashboard</a>
      <a href="login.html">Login</a>
    </nav>
    <header>
      <h1>Jamaica Multi-Vendor Marketplace</h1>
      <p>Discover local products from trusted vendors.</p>
    </header>

    <!-- Search & Filters Section -->
    <div id="search-filters">
      <input type="text" id="searchInput" placeholder="Search vendors..." />
      <select id="categoryFilter">
        <option value="">All Categories</option>
        <option value="Food">Food</option>
        <option value="Clothing">Clothing</option>
        <option value="Electronics">Electronics</option>
      </select>
      <input type="number" id="minPrice" placeholder="Min Price" />
      <input type="number" id="maxPrice" placeholder="Max Price" />
      <button id="applyFilters">Apply Filters</button>
    </div>

    <!-- Vendor Listings Section -->
    <section id="vendor-list">
      <!-- Vendor listings loaded via Firestore will appear here -->
    </section>

    <footer>
      <p>&copy; 2025 Jamaica Multi-Vendor Marketplace</p>
    </footer>

    <!-- Vendor Dashboard -->
    <div id="vendor-dashboard">
      <h2>Vendor Dashboard</h2>
      <form id="vendorForm">
        <input type="text" id="vendorName" placeholder="Store Name" />
        <input type="text" id="vendorCategory" placeholder="Category" />
        <input type="number" id="vendorPrice" placeholder="Price" />
        <input type="url" id="vendorImage" placeholder="Image URL" />
        <button type="submit">Add Vendor</button>
      </form>

      <h3>Your Listings</h3>
      <div id="vendorListings"></div>
    </div>

    <script>
      // Firebase configuration and initialization
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
        measurementId: "YOUR_MEASUREMENT_ID",
      };
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const vendorList = document.getElementById("vendor-list");
      const vendorForm = document.getElementById("vendorForm");
      const vendorListings = document.getElementById("vendorListings");

      let lastVisible = null;
      const vendorsPerPage = 10;

      // Load vendors with filtering and pagination
      async function loadVendors() {
        let searchText = document.getElementById("searchInput").value.toLowerCase();
        let category = document.getElementById("categoryFilter").value;
        let minPrice = document.getElementById("minPrice").value;
        let maxPrice = document.getElementById("maxPrice").value;

        let vendorsQuery = firebase.firestore().collection("vendors").orderBy("name");

        if (lastVisible) {
          vendorsQuery = vendorsQuery.startAfter(lastVisible);
        }

        const querySnapshot = await vendorsQuery.limit(vendorsPerPage).get();

        if (!querySnapshot.empty) {
          lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];

          querySnapshot.forEach((doc) => {
            const vendor = doc.data();

            // Filtering logic
            if (
              (searchText && !vendor.name.toLowerCase().includes(searchText)) ||
              (category && vendor.category !== category) ||
              (minPrice && vendor.price < minPrice) ||
              (maxPrice && vendor.price > maxPrice)
            )
              return;

            const vendorCard = document.createElement("div");
            vendorCard.innerHTML = `
              <h3>${vendor.name}</h3>
              <p>Category: ${vendor.category}</p>
              <p>Price: $${vendor.price}</p>
              <img src="${vendor.profilePhoto}" width="100">
            `;
            vendorList.appendChild(vendorCard);
          });
        }
      }

      // Add event listener for the filter button
      document.getElementById("applyFilters").addEventListener("click", () => {
        lastVisible = null; // Reset pagination
        vendorList.innerHTML = ""; // Clear existing results
        loadVendors();
      });

      // Fetch vendor listings for the dashboard
      async function fetchVendors() {
        vendorListings.innerHTML = "";
        const querySnapshot = await firebase.firestore().collection("vendors").get();
        querySnapshot.forEach((doc) => {
          const vendor = doc.data();
          const vendorItem = document.createElement("div");
          vendorItem.innerHTML = `
            <h3>${vendor.name}</h3>
            <p>Category: ${vendor.category}</p>
            <p>Price: $${vendor.price}</p>
            <img src="${vendor.profilePhoto}" width="100">
            <button onclick="deleteVendor('${doc.id}')">Delete</button>
          `;
          vendorListings.appendChild(vendorItem);
        });
      }

      // Add vendor to the database
      vendorForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const vendorData = {
          name: document.getElementById("vendorName").value,
          category: document.getElementById("vendorCategory").value,
          price: document.getElementById("vendorPrice").value,
          profilePhoto: document.getElementById("vendorImage").value,
        };
        await firebase.firestore().collection("vendors").add(vendorData);
        fetchVendors(); // Refresh the list
      });

      // Delete vendor from the database
      window.deleteVendor = async (id) => {
        await firebase.firestore().collection("vendors").doc(id).delete();
        fetchVendors(); // Refresh the list
      };

      // Initial load
      loadVendors();
      fetchVendors();
    </script>
  </body>
</html>
