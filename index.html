<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BizFinder JA</title>
  <!-- Chart.js for interactive graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
  <!-- Stripe SDK -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* CSS Variables */
    :root {
      --primary-green: #2ecc71;
      --secondary-green: #27ae60;
      --light-bg: #f5f9fc;
      --light-bg-alt: #e6f0fa;
      --text-color: #333;
      --muted-color: #7f8c8d;
      --accent-blue: #3498db;
      --accent-blue-hover: #2980b9;
      --white: #fff;
      --premium-bg: linear-gradient(135deg, #ffffff, #f0f8ff);
      --premium-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: linear-gradient(135deg, var(--light-bg), var(--light-bg-alt));
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Header */
    header {
      background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      font-size: 1.5rem;
    }
    #businessName {
      cursor: pointer;
    }
    .header-buttons {
      display: flex;
      gap: 1rem;
    }
    .header-buttons button {
      background: var(--white);
      color: var(--primary-green);
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    }
    .header-buttons button:hover {
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* Container */
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    
    /* Mobile Optimization */
    @media (max-width: 1024px) {
      .container {
        margin: 1rem auto;
        padding: 0 1rem;
      }
      header {
        flex-direction: column;
        gap: 1rem;
      }
      .header-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
      .hot-products {
        padding: 1rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .hot-product-grid {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        animation: mobileSlide 15s infinite ease-in-out;
      }
      .hot-product-item {
        flex: 0 0 auto;
        width: 45%;
        margin: 0.25rem 0;
        padding: 0.5rem;
      }
    }
    
    /* Search Bar */
    .search-container {
      margin-bottom: 1.5rem;
      position: relative;
    }
    #search-bar {
      width: 100%;
      padding: 0.875rem 1.5rem;
      border: 2px solid #ddd;
      border-radius: 25px;
      font-size: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #search-bar:focus {
      border-color: var(--primary-green);
      outline: none;
      box-shadow: 0 4px 15px rgba(46,204,113,0.3);
    }
    #search-results-info {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--muted-color);
      text-align: center;
      margin-bottom: 10px;
    }
    
    /* Cards and Pages */
    .business-card,
    .store-page,
    .profile-page {
      background: var(--white);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .business-card:hover,
    .store-page:hover,
    .profile-page:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    .business-card h3,
    .store-page h3,
    .profile-page h3 {
      margin-bottom: 1rem;
      color: var(--primary-green);
      font-size: 1.5rem;
      font-weight: 600;
    }
    .business-card .category,
    .store-page .category {
      font-style: italic;
      color: var(--muted-color);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .business-image {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .letter-avatar {
      width: 150px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      color: var(--white);
      border-radius: 50%;
      margin-bottom: 1rem;
    }
    
    /* Status Indicator */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: 5px;
    }
    
    /* Contact Links */
    .contact a {
      margin-right: 1rem;
      text-decoration: none;
      color: var(--accent-blue);
      font-size: 0.9rem;
      transition: color 0.3s;
    }
    .contact a:hover {
      color: var(--accent-blue-hover);
    }
    .views {
      font-size: 0.875rem;
      color: var(--muted-color);
      margin-top: 0.75rem;
    }
    
    /* Global Button Styles */
    button {
      background: var(--primary-green);
      color: var(--white);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    }
    button:hover {
      background: var(--secondary-green);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* Modal Styles */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--white);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--premium-shadow);
      z-index: 1000;
      text-align: center;
      max-width: 500px;
      width: 90%;
      display: none;
    }
    .modal h2 {
      color: var(--primary-green);
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      font-weight: 600;
    }
    input,
    select,
    textarea {
      display: block;
      width: 100%;
      margin: 0.75rem 0;
      padding: 0.875rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary-green);
      outline: none;
      box-shadow: 0 4px 15px rgba(46,204,113,0.3);
    }
    .modal .error {
      color: #e74c3c;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    /* Hot Products */
    .hot-products {
      background: var(--premium-bg);
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      box-shadow: var(--premium-shadow);
      border-left: 8px solid var(--primary-green);
      position: relative;
      overflow: hidden;
    }
    .hot-products h3 {
      font-size: 1.5rem;
      color: var(--primary-green);
      margin-bottom: 1rem;
      font-weight: 700;
      text-align: center;
    }
    .hot-products .hot-product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      padding: 1rem;
      animation: pcSlide 20s infinite ease-in-out;
    }
    @media (min-width: 1025px) {
      .hot-products .hot-product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .hot-product-item {
      background: var(--white);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      cursor: pointer;
    }
    .hot-product-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .hot-product-item img {
      width: 80px;
      height: 80px;
      margin-right: 1rem;
      border-radius: 8px;
      object-fit: cover;
      loading: lazy;
    }
    .hot-product-item span {
      font-size: 1rem;
      color: var(--text-color);
      flex-grow: 1;
      font-weight: 500;
    }
    .hot-product-item::after {
      content: "ðŸ”¥";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      animation: firePulse 1.5s infinite ease-in-out;
    }

    /* Animations */
    @keyframes firePulse {
      0%, 100% { opacity: 0.7; transform: translateY(-50%) scale(1); }
      50% { opacity: 1; transform: translateY(-50%) scale(1.2); }
    }
    @keyframes pcSlide {
      0%, 10% { transform: translateX(0); }
      20%, 30% { transform: translateX(-33.33%); }
      40%, 50% { transform: translateX(-66.66%); }
      60%, 70% { transform: translateX(-100%); }
      80%, 90% { transform: translateX(-66.66%); }
      100% { transform: translateX(0); }
    }
    @keyframes mobileSlide {
      0%, 25% { transform: translateX(0); }
      50%, 75% { transform: translateX(-50%); }
      100% { transform: translateX(0); }
    }

    /* Hot Product Popup */
    #hot-product-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--premium-bg);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--premium-shadow);
      z-index: 2000;
      text-align: center;
      max-width: 400px;
      width: 90%;
      display: none;
    }
    #hot-product-popup img {
      width: 150px;
      height: 150px;
      border-radius: 10px;
      object-fit: cover;
      margin-bottom: 1rem;
      loading: lazy;
    }
    #hot-product-popup h3 {
      color: var(--primary-green);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    #hot-product-popup p {
      font-size: 1rem;
      color: var(--text-color);
      margin-bottom: 1rem;
    }
    #hot-product-popup .views {
      font-size: 0.9rem;
      color: var(--muted-color);
      margin-bottom: 1rem;
    }
    #hot-product-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted-color);
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 1.5rem;
      display: none;
      color: var(--muted-color);
      font-size: 1rem;
    }
    
    /* Feed Grid */
    .feed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    /* Store Page */
    .store-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      padding: 1rem;
    }
    .business-info {
      text-align: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }
    .products-section h4 {
      margin-bottom: 1rem;
      color: var(--primary-green);
      font-size: 1.5rem;
      text-align: center;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    .product-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .product-card img {
      width: 100%;
      object-fit: cover;
      height: 150px;
      loading: lazy;
    }
    .product-info {
      padding: 1rem;
      text-align: center;
    }
    .product-name {
      font-size: 1.1rem;
      color: var(--primary-green);
      margin-bottom: 0.5rem;
    }
    .product-desc {
      font-size: 0.95rem;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }
    .product-views {
      font-size: 0.85rem;
      color: var(--muted-color);
    }
    
    /* Profile Page */
    .profile-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--premium-shadow);
      text-align: center;
    }
    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .profile-header img,
    .profile-header .letter-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      loading: lazy;
    }
    .product-list {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .product-item {
      background: var(--white);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .product-item-actions button {
      margin-left: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    /* Additional Modal Styles */
    #settings-modal, #add-product-modal, #edit-product-modal, #manage-products-modal {
      max-width: 500px;
      width: 90%;
    }
    #payment-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--white);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--premium-shadow);
      z-index: 1000;
      text-align: center;
      max-width: 500px;
      width: 90%;
      display: none;
    }
    #payment-modal input {
      width: 100%;
      margin: 0.75rem 0;
    }
  </style>
</head>
<body>
  <header>
    <span id="businessName">BizFinder JA</span>
    <div class="header-buttons">
      <button id="profile-btn" style="display: none;">Profile</button>
      <button id="login-btn">Login</button>
      <button id="signup-btn">Sign Up</button>
    </div>
  </header>

  <div class="container" id="main-content">
    <div class="search-container">
      <input type="text" id="search-bar" placeholder="Search businesses..." />
      <div id="search-results-info"></div>
    </div>
    <div id="hot-products" class="hot-products">
      <h3>Hot Products</h3>
      <div class="hot-product-grid"></div>
    </div>
    <div id="feed" class="feed-grid"></div>
    <div id="store-page" class="store-page" style="display: none;"></div>
    <div id="profile-page" class="profile-page" style="display: none;"></div>
    <div id="loading" class="loading">Loading...</div>
  </div>

  <!-- Modals -->
  <div id="popup" class="modal">
    <h2>Welcome to BizFinder JA!</h2>
    <p>Sign up to join our vibrant community.</p>
    <button id="business-btn">Sign Up as Business</button>
    <button id="customer-btn">Sign Up as Customer</button>
    <button id="feed-btn">Continue to Feed</button>
  </div>

  <div id="business-form" class="modal">
    <h2>Business Sign-Up</h2>
    <input type="text" id="biz-name" placeholder="Business Name" required />
    <input type="email" id="biz-email" placeholder="Email" required />
    <input type="password" id="biz-password" placeholder="Password" required />
    <select id="biz-category">
      <option value="Food & Drinks">Food & Drinks</option>
      <option value="Fashion & Accessories">Fashion & Accessories</option>
      <option value="Tech & Electronics">Tech & Electronics</option>
      <option value="Home & Kitchen">Home & Kitchen</option>
      <option value="Beauty & Personal Care">Beauty & Personal Care</option>
    </select>
    <input type="text" id="biz-product" placeholder="Featured Product Name" required />
    <input type="text" id="biz-desc" placeholder="Short Description" required />
    <input type="text" id="biz-whatsapp" placeholder="WhatsApp Number (e.g., 876551234)" required />
    <input type="text" id="biz-instagram" placeholder="Instagram Handle (e.g., tasteofmobay)" required />
    <input type="text" id="biz-location" placeholder="Location (e.g., Montego Bay)" required />
    <input type="file" id="biz-photo" accept="image/*" />
    <button id="submit-business-btn">Submit</button>
    <div id="business-form-error" class="error"></div>
    <button class="close-btn" data-form="business-form">Close</button>
  </div>

  <div id="customer-form" class="modal">
    <h2>Customer Sign-Up</h2>
    <input type="text" id="cust-name" placeholder="Name" required />
    <input type="email" id="cust-email" placeholder="Email" required />
    <input type="password" id="cust-password" placeholder="Password" required />
    <button id="submit-customer-btn">Submit</button>
    <div id="customer-form-error" class="error"></div>
    <button class="close-btn" data-form="customer-form">Close</button>
  </div>

  <div id="login-form" class="modal">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button id="login-submit-btn">Login</button>
    <div id="login-form-error" class="error"></div>
    <button class="close-btn" data-form="login-form">Close</button>
  </div>

  <div id="settings-modal" class="modal">
    <h2>Settings</h2>
    <input type="text" id="settings-name" placeholder="Your Name" required />
    <input type="file" id="settings-photo" accept="image/*" />
    <button id="save-settings-btn">Save Settings</button>
    <div id="settings-error" class="error"></div>
    <button class="close-btn" data-form="settings-modal">Close</button>
  </div>

  <div id="add-product-modal" class="modal">
    <h2>Add Product</h2>
    <input type="text" id="prod-name" placeholder="Product Name" required />
    <textarea id="prod-desc" placeholder="Product Description" rows="3" required></textarea>
    <input type="number" id="prod-price" placeholder="Price (JMD)" required />
    <input type="file" id="prod-media" accept="image/*" />
    <button id="submit-product-btn">Add Product</button>
    <div id="add-product-error" class="error"></div>
    <button class="close-btn" data-form="add-product-modal">Close</button>
  </div>

  <div id="edit-product-modal" class="modal">
    <h2>Edit Product</h2>
    <input type="text" id="edit-prod-name" placeholder="Product Name" required />
    <textarea id="edit-prod-desc" placeholder="Product Description" rows="3" required></textarea>
    <input type="number" id="edit-prod-price" placeholder="Price (JMD)" required />
    <input type="file" id="edit-prod-media" accept="image/*" />
    <button id="save-product-btn">Save Changes</button>
    <div id="edit-product-error" class="error"></div>
    <button class="close-btn" data-form="edit-product-modal">Close</button>
  </div>

  <div id="manage-products-modal" class="modal">
    <h2>Manage Products</h2>
    <div class="product-list" id="manage-product-list"></div>
    <button class="close-btn" data-form="manage-products-modal">Close</button>
  </div>

  <div id="hot-product-popup" class="modal">
    <button class="close-btn" data-form="hot-product-popup">Ã—</button>
    <img id="hot-product-img" alt="Product Image">
    <h3 id="hot-product-name"></h3>
    <p id="hot-product-desc"></p>
    <p class="views" id="hot-product-views"></p>
    <button id="view-store-btn">View Store</button>
  </div>

  <div id="payment-modal" class="modal">
    <h2>Checkout</h2>
    <input type="text" id="cardholder-name" placeholder="Cardholder Name" required />
    <div id="card-element"></div>
    <button id="submit-payment-btn">Pay Now</button>
    <div id="payment-error" class="error"></div>
    <button class="close-btn" data-form="payment-modal">Close</button>
  </div>

  <script>
    'use strict';

    // Firebase Configuration (Replace with your own Firebase config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY'); // Replace with your Stripe key
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    let currentUser = null;
    let businesses = [];
    let currentBusinesses = [];

    // Mount Stripe card element
    document.addEventListener('DOMContentLoaded', () => {
      cardElement.mount('#card-element');
    });

    // Helper Functions
    function closeModal(formId) {
      const modal = document.getElementById(formId);
      if (modal) {
        modal.style.display = 'none';
        const error = document.getElementById(`${formId}-error`);
        if (error) error.style.display = 'none';
      }
    }

    function getLetterAvatar(name) {
      const letter = name.charAt(0).toUpperCase();
      const colors = ["#f39c12", "#e74c3c", "#8e44ad", "#3498db", "#1abc9c"];
      const color = colors[Math.floor(Math.random() * colors.length)];
      return `<div class="letter-avatar" style="background:${color};">${letter}</div>`;
    }

    function isStoreOpen(business) {
      const now = new Date();
      const [openH, openM] = business.openingHour.split(":").map(Number);
      const [closeH, closeM] = business.closingHour.split(":").map(Number);
      const openDate = new Date(now).setHours(openH, openM, 0, 0);
      const closeDate = new Date(now).setHours(closeH, closeM, 0, 0);
      return now >= openDate && now <= closeDate;
    }

    async function uploadFile(file, path) {
      const ref = storage.ref().child(path);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    // UI Updates
    function updateUIForUser() {
      document.getElementById('profile-btn').style.display = currentUser ? 'block' : 'none';
      document.getElementById('login-btn').style.display = currentUser ? 'none' : 'block';
      document.getElementById('signup-btn').style.display = currentUser ? 'none' : 'block';
    }

    // Fetch Businesses
    async function fetchBusinesses() {
      try {
        const snapshot = await db.collection('businesses').get();
        businesses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        currentBusinesses = businesses;
        displayFeed();
      } catch (error) {
        console.error('Error fetching businesses:', error);
        alert('Failed to load businesses.');
      }
    }

    // Display Feed
    async function displayFeed() {
      const feed = document.getElementById('feed');
      feed.style.display = 'block';
      document.getElementById('store-page').style.display = 'none';
      document.getElementById('profile-page').style.display = 'none';
      feed.innerHTML = '<div class="feed-grid"></div>';
      const grid = feed.querySelector('.feed-grid');
      const info = document.getElementById('search-results-info');
      info.textContent = `Found ${currentBusinesses.length} results`;
      
      currentBusinesses.forEach(business => {
        const product = business.products[0] || { name: 'No product', photo: '' };
        const card = document.createElement('div');
        card.className = 'business-card';
        card.innerHTML = `
          <h3>${business.name} <span class="status-indicator" style="background: ${isStoreOpen(business) ? 'green' : 'red'};"></span></h3>
          <p class="category">${business.category}</p>
          ${business.displayPhoto ? `<img class="business-image" src="${business.displayPhoto}" alt="${business.name}" loading="lazy">` : getLetterAvatar(business.name)}
          <p><strong>Featured Product:</strong> ${product.name}</p>
          ${product.photo ? `<img src="${product.photo}" alt="${product.name}" loading="lazy">` : ''}
          <p>${business.desc}</p>
          <p><strong>Location:</strong> ${business.location}</p>
          <div class="contact">
            <a href="https://wa.me/${business.whatsapp}" target="_blank">WhatsApp</a>
            <a href="https://instagram.com/${business.instagram}" target="_blank">Instagram</a>
          </div>
          <p class="views">Views: ${business.views}</p>
          <button class="view-store-btn" data-id="${business.id}">View Store</button>
        `;
        grid.appendChild(card);
      });
      displayHotProducts();
    }

    // Display Hot Products
    function displayHotProducts() {
      const grid = document.querySelector('.hot-product-grid');
      const hot = businesses.sort((a, b) => b.views - a.views).slice(0, 6);
      grid.innerHTML = '';
      hot.forEach(biz => {
        const product = biz.products[0] || { name: 'No product', photo: '' };
        const item = document.createElement('div');
        item.className = 'hot-product-item';
        item.innerHTML = `
          <img src="${product.photo || 'https://via.placeholder.com/80'}" alt="${product.name}" loading="lazy">
          <span>${biz.name} - ${product.name}</span>
        `;
        item.addEventListener('click', () => showHotProductPopup(biz.id, product));
        grid.appendChild(item);
      });
    }

    // Show Hot Product Popup
    function showHotProductPopup(bizId, product) {
      const popup = document.getElementById('hot-product-popup');
      document.getElementById('hot-product-img').src = product.photo || 'https://via.placeholder.com/150';
      document.getElementById('hot-product-name').textContent = product.name;
      document.getElementById('hot-product-desc').textContent = product.desc;
      document.getElementById('hot-product-views').textContent = `Views: ${businesses.find(b => b.id === bizId).views}`;
      document.getElementById('view-store-btn').onclick = () => { viewStore(bizId); closeModal('hot-product-popup'); };
      popup.style.display = 'block';
    }

    // View Store
    async function viewStore(bizId) {
      const business = businesses.find(b => b.id === bizId);
      if (!business) return;
      business.views++;
      await db.collection('businesses').doc(bizId).update({ views: business.views });
      if (currentUser && currentUser.type === 'customer') {
        const userRef = db.collection('users').doc(currentUser.uid);
        const recentlyViewed = currentUser.recentlyViewed || [];
        recentlyViewed.unshift({ id: bizId, name: business.name });
        await userRef.update({ recentlyViewed: recentlyViewed.slice(0, 10) });
      }
      const storePage = document.getElementById('store-page');
      storePage.style.display = 'block';
      document.getElementById('feed').style.display = 'none';
      document.getElementById('profile-page').style.display = 'none';
      storePage.innerHTML = `
        <button class="back-to-feed-btn">Back to Feed</button>
        <div class="store-container">
          <div class="business-info">
            <h3>${business.name} <span class="status-indicator" style="background: ${isStoreOpen(business) ? 'green' : 'red'};"></span></h3>
            <p class="category">${business.category}</p>
            ${business.displayPhoto ? `<img src="${business.displayPhoto}" alt="${business.name}" loading="lazy">` : getLetterAvatar(business.name)}
            <p>${business.desc}</p>
            <p><strong>Location:</strong> ${business.location}</p>
            <div class="contact">
              <a href="https://wa.me/${business.whatsapp}" target="_blank">WhatsApp</a>
              <a href="https://instagram.com/${business.instagram}" target="_blank">Instagram</a>
            </div>
            <p class="views">Views: ${business.views}</p>
          </div>
          <div class="products-section">
            <h4>Products</h4>
            <div class="products-grid">
              ${business.products.map(p => `
                <div class="product-card">
                  <img src="${p.photo || 'https://via.placeholder.com/150'}" alt="${p.name}" loading="lazy">
                  <div class="product-info">
                    <p class="product-name">${p.name}</p>
                    <p class="product-desc">${p.desc}</p>
                    <p class="product-views">Price: J$${p.price}</p>
                    <button class="buy-now-btn" data-id="${bizId}" data-product="${p.name}">Buy Now</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.querySelectorAll('.buy-now-btn').forEach(btn => {
        btn.addEventListener('click', () => initiatePayment(bizId, btn.getAttribute('data-product')));
      });
    }

    // Show Profile
    async function showProfile() {
      if (!currentUser) return;
      const profilePage = document.getElementById('profile-page');
      profilePage.style.display = 'block';
      document.getElementById('feed').style.display = 'none';
      document.getElementById('store-page').style.display = 'none';
      let content = `
        <div class="profile-container">
          <button id="back-to-${currentUser.type === 'business' ? 'store' : 'feed'}">Back to ${currentUser.type === 'business' ? 'Store' : 'Feed'}</button>
          <div class="profile-header">
            ${currentUser.profilePhoto ? `<img src="${currentUser.profilePhoto}" alt="${currentUser.name}" loading="lazy">` : getLetterAvatar(currentUser.name)}
            <h3>${currentUser.name}</h3>
            <p>${currentUser.email}</p>
          </div>
      `;
      if (currentUser.type === 'business') {
        const business = businesses.find(b => b.id === currentUser.uid);
        content += `
          <div class="profile-details">
            <h4>Business Metrics</h4>
            <p>Total Views: ${business.views}</p>
            <button id="add-product-btn">Add Product</button>
            <button id="manage-products-btn">Manage Products</button>
            <div class="product-list">
              ${business.products.map(p => `
                <div class="product-item">
                  <span>${p.name} - J$${p.price}</span>
                  <div class="product-item-actions">
                    <button class="edit-product-btn" data-id="${p.name}">Edit</button>
                    <button class="delete-product-btn" data-id="${p.name}">Delete</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <canvas id="viewsChart"></canvas>
          </div>
        `;
      } else {
        content += `
          <div class="profile-details">
            <h4>Recently Viewed</h4>
            ${currentUser.recentlyViewed ? currentUser.recentlyViewed.map(item => `<p>${item.name}</p>`).join('') : '<p>No recent views.</p>'}
          </div>
        `;
      }
      content += `
          <button id="settings-btn">Settings</button>
          <button id="logout-btn">Logout</button>
        </div>
      `;
      profilePage.innerHTML = content;
      if (currentUser.type === 'business') initViewsChart();
    }

    // Initialize Chart
    function initViewsChart() {
      const ctx = document.getElementById('viewsChart').getContext('2d');
      const business = businesses.find(b => b.id === currentUser.uid);
      const data = Array(7).fill(0).map((_, i) => business.views - i * 10); // Mock data
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array(7).fill(0).map((_, i) => `Day ${i + 1}`),
          datasets: [{ label: 'Views', data, borderColor: '#2ecc71', fill: true }]
        },
        options: { responsive: true }
      });
    }

    // Payment Processing
    async function initiatePayment(bizId, productName) {
      const business = businesses.find(b => b.id === bizId);
      const product = business.products.find(p => p.name === productName);
      const paymentModal = document.getElementById('payment-modal');
      paymentModal.style.display = 'block';
      document.getElementById('submit-payment-btn').onclick = async () => {
        const cardholderName = document.getElementById('cardholder-name').value;
        const { paymentIntent, error } = await stripe.createPaymentIntent({
          amount: product.price * 100, // Convert to cents
          currency: 'jmd',
          payment_method_data: {
            billing_details: { name: cardholderName }
          }
        });
        if (error) {
          document.getElementById('payment-error').textContent = error.message;
          document.getElementById('payment-error').style.display = 'block';
        } else {
          closeModal('payment-modal');
          alert('Payment successful!');
        }
      };
    }

    // Event Listeners
    auth.onAuthStateChanged(user => {
      currentUser = user ? { uid: user.uid, email: user.email, ...user.metadata } : null;
      updateUIForUser();
      if (user) fetchUserData();
      else document.getElementById('popup').style.display = 'block';
      fetchBusinesses();
    });

    async function fetchUserData() {
      const doc = await db.collection('users').doc(currentUser.uid).get();
      if (doc.exists) Object.assign(currentUser, doc.data());
    }

    document.getElementById('business-btn').addEventListener('click', () => {
      closeModal('popup');
      document.getElementById('business-form').style.display = 'block';
    });

    document.getElementById('customer-btn').addEventListener('click', () => {
      closeModal('popup');
      document.getElementById('customer-form').style.display = 'block';
    });

    document.getElementById('feed-btn').addEventListener('click', () => {
      closeModal('popup');
      displayFeed();
    });

    document.getElementById('login-btn').addEventListener('click', () => {
      document.getElementById('login-form').style.display = 'block';
    });

    document.getElementById('signup-btn').addEventListener('click', () => {
      document.getElementById('popup').style.display = 'block';
    });

    document.getElementById('profile-btn').addEventListener('click', showProfile);

    document.getElementById('submit-business-btn').addEventListener('click', async () => {
      try {
        const name = document.getElementById('biz-name').value;
        const email = document.getElementById('biz-email').value;
        const password = document.getElementById('biz-password').value;
        const category = document.getElementById('biz-category').value;
        const product = document.getElementById('biz-product').value;
        const desc = document.getElementById('biz-desc').value;
        const whatsapp = document.getElementById('biz-whatsapp').value;
        const instagram = document.getElementById('biz-instagram').value;
        const location = document.getElementById('biz-location').value;
        const photoFile = document.getElementById('biz-photo').files[0];
        if (!name || !email || !password || !product) throw new Error('All fields are required');
        
        const { user } = await auth.createUserWithEmailAndPassword(email, password);
        const photoURL = photoFile ? await uploadFile(photoFile, `businesses/${user.uid}/profile.jpg`) : '';
        const business = {
          id: user.uid,
          name,
          category,
          products: [{ name: product, desc, photo: '', price: 0, views: 0 }],
          desc,
          whatsapp,
          instagram,
          location,
          displayPhoto: photoURL,
          views: 0,
          openingHour: '09:00',
          closingHour: '18:00'
        };
        await db.collection('businesses').doc(user.uid).set(business);
        await db.collection('users').doc(user.uid).set({ name, type: 'business', profilePhoto: photoURL });
        closeModal('business-form');
      } catch (error) {
        document.getElementById('business-form-error').textContent = error.message;
        document.getElementById('business-form-error').style.display = 'block';
      }
    });

    document.getElementById('submit-customer-btn').addEventListener('click', async () => {
      try {
        const name = document.getElementById('cust-name').value;
        const email = document.getElementById('cust-email').value;
        const password = document.getElementById('cust-password').value;
        if (!name || !email || !password) throw new Error('All fields are required');
        
        const { user } = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(user.uid).set({ name, type: 'customer', recentlyViewed: [] });
        closeModal('customer-form');
      } catch (error) {
        document.getElementById('customer-form-error').textContent = error.message;
        document.getElementById('customer-form-error').style.display = 'block';
      }
    });

    document.getElementById('login-submit-btn').addEventListener('click', async () => {
      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        await auth.signInWithEmailAndPassword(email, password);
        closeModal('login-form');
      } catch (error) {
        document.getElementById('login-form-error').textContent = error.message;
        document.getElementById('login-form-error').style.display = 'block';
      }
    });

    document.getElementById('submit-product-btn').addEventListener('click', async () => {
      try {
        const name = document.getElementById('prod-name').value;
        const desc = document.getElementById('prod-desc').value;
        const price = parseFloat(document.getElementById('prod-price').value);
        const file = document.getElementById('prod-media').files[0];
        if (!name || !desc || !price) throw new Error('All fields are required');
        
        const photoURL = file ? await uploadFile(file, `products/${currentUser.uid}/${name}.jpg`) : '';
        const product = { name, desc, photo: photoURL, price, views: 0 };
        const businessRef = db.collection('businesses').doc(currentUser.uid);
        const business = businesses.find(b => b.id === currentUser.uid);
        business.products.push(product);
        await businessRef.update({ products: business.products });
        closeModal('add-product-modal');
        showProfile();
      } catch (error) {
        document.getElementById('add-product-error').textContent = error.message;
        document.getElementById('add-product-error').style.display = 'block';
      }
    });

    document.getElementById('save-settings-btn').addEventListener('click', async () => {
      try {
        const name = document.getElementById('settings-name').value;
        const file = document.getElementById('settings-photo').files[0];
        if (!name) throw new Error('Name is required');
        
        const photoURL = file ? await uploadFile(file, `users/${currentUser.uid}/profile.jpg`) : currentUser.profilePhoto;
        await db.collection('users').doc(currentUser.uid).update({ name, profilePhoto: photoURL });
        if (currentUser.type === 'business') {
          await db.collection('businesses').doc(currentUser.uid).update({ name, displayPhoto: photoURL });
        }
        currentUser.name = name;
        currentUser.profilePhoto = photoURL;
        closeModal('settings-modal');
        showProfile();
      } catch (error) {
        document.getElementById('settings-error').textContent = error.message;
        document.getElementById('settings-error').style.display = 'block';
      }
    });

    document.body.addEventListener('click', async e => {
      if (e.target.classList.contains('close-btn')) closeModal(e.target.getAttribute('data-form'));
      if (e.target.id === 'logout-btn') await auth.signOut();
      if (e.target.id === 'settings-btn') {
        document.getElementById('settings-modal').style.display = 'block';
        document.getElementById('settings-name').value = currentUser.name;
      }
      if (e.target.id === 'add-product-btn') document.getElementById('add-product-modal').style.display = 'block';
      if (e.target.id === 'manage-products-btn') {
        const business = businesses.find(b => b.id === currentUser.uid);
        document.getElementById('manage-product-list').innerHTML = business.products.map(p => `
          <div class="product-item">
            <span>${p.name} - J$${p.price}</span>
            <div class="product-item-actions">
              <button class="edit-product-btn" data-id="${p.name}">Edit</button>
              <button class="delete-product-btn" data-id="${p.name}">Delete</button>
            </div>
          </div>
        `).join('');
        document.getElementById('manage-products-modal').style.display = 'block';
      }
      if (e.target.classList.contains('edit-product-btn')) {
        const name = e.target.getAttribute('data-id');
        const business = businesses.find(b => b.id === currentUser.uid);
        const product = business.products.find(p => p.name === name);
        document.getElementById('edit-prod-name').value = product.name;
        document.getElementById('edit-prod-desc').value = product.desc;
        document.getElementById('edit-prod-price').value = product.price;
        document.getElementById('edit-product-modal').style.display = 'block';
        document.getElementById('save-product-btn').onclick = async () => {
          try {
            const newName = document.getElementById('edit-prod-name').value;
            const desc = document.getElementById('edit-prod-desc').value;
            const price = parseFloat(document.getElementById('edit-prod-price').value);
            const file = document.getElementById('edit-prod-media').files[0];
            const photoURL = file ? await uploadFile(file, `products/${currentUser.uid}/${newName}.jpg`) : product.photo;
            product.name = newName;
            product.desc = desc;
            product.price = price;
            product.photo = photoURL;
            await db.collection('businesses').doc(currentUser.uid).update({ products: business.products });
            closeModal('edit-product-modal');
            showProfile();
          } catch (error) {
            document.getElementById('edit-product-error').textContent = error.message;
            document.getElementById('edit-product-error').style.display = 'block';
          }
        };
      }
      if (e.target.classList.contains('delete-product-btn')) {
        const name = e.target.getAttribute('data-id');
        const business = businesses.find(b => b.id === currentUser.uid);
        business.products = business.products.filter(p => p.name !== name);
        await db.collection('businesses').doc(currentUser.uid).update({ products: business.products });
        showProfile();
      }
      if (e.target.classList.contains('view-store-btn')) viewStore(e.target.getAttribute('data-id'));
      if (e.target.id === 'back-to-feed') displayFeed();
      if (e.target.id === 'back-to-store') viewStore(currentUser.uid);
    });

    document.getElementById('search-bar').addEventListener('keyup', () => {
      const query = document.getElementById('search-bar').value.toLowerCase();
      currentBusinesses = businesses.filter(b => 
        b.name.toLowerCase().includes(query) || 
        b.category.toLowerCase().includes(query) || 
        b.products.some(p => p.name.toLowerCase().includes(query))
      );
      displayFeed();
    });
  </script>
</body>
</html>