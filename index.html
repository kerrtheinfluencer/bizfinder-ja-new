<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multivendor Marketplace</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@5.0.0/umd/material-ui.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body { margin: 0; font-family: 'Roboto', sans-serif; }
    #root { padding: 20px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const {
      Container, Typography, Button, TextField, Grid, Card, CardContent, CardActions,
      AppBar, Toolbar, IconButton, Avatar, Menu, MenuItem, CircularProgress,
      InputAdornment, SearchIcon
    } = MaterialUI;

    // Firebase configuration (using your provided credentials)
    const firebaseConfig = {
      apiKey: "AIzaSyBPk2blB_5XsrF8Biw01GxQjtY-A8RMeBI",
      authDomain: "bizfinder-7b1b6.firebaseapp.com",
      projectId: "bizfinder-7b1b6",
      storageBucket: "bizfinder-7b1b6.firebasestorage.app",
      messagingSenderId: "953228556886",
      appId: "1:953228556886:web:8c589d5a59a75045c959f7",
      measurementId: "G-SW2BZ8LD07"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Authentication Component
    function Auth({ setUserRole }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [user, setUser] = useState(null);
      const [role, setRole] = useState('customer'); // customer or vendor
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            setUser(user);
            setUserRole(userData?.role || 'customer');
          } else {
            setUser(null);
            setUserRole('customer');
          }
        });
        return () => unsubscribe();
      }, []);

      const handleSignup = async () => {
        setLoading(true);
        try {
          const { user } = await auth.createUserWithEmailAndPassword(email, password);
          await db.collection('users').doc(user.uid).set({ email, role });
          setError('');
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleLogin = async () => {
        setLoading(true);
        try {
          await auth.signInWithEmailAndPassword(email, password);
          setError('');
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      const handleLogout = async () => {
        await auth.signOut();
      };

      if (user) return null; // Handled in AppBar

      return (
        <Container maxWidth="xs" style={{ marginTop: '50px' }}>
          <Typography variant="h5" align="center">Login / Signup</Typography>
          {error && <Typography color="error" align="center">{error}</Typography>}
          <TextField
            label="Email"
            fullWidth
            margin="normal"
            value={email}
            onChange={e => setEmail(e.target.value)}
          />
          <TextField
            label="Password"
            type="password"
            fullWidth
            margin="normal"
            value={password}
            onChange={e => setPassword(e.target.value)}
          />
          <Grid container spacing={2} alignItems="center">
            <Grid item xs={6}>
              <Button
                variant="contained"
                color="primary"
                fullWidth
                onClick={handleSignup}
                disabled={loading}
              >
                {loading ? <CircularProgress size={24} /> : 'Signup'}
              </Button>
            </Grid>
            <Grid item xs={6}>
              <Button
                variant="contained"
                fullWidth
                onClick={handleLogin}
                disabled={loading}
              >
                {loading ? <CircularProgress size={24} /> : 'Login'}
              </Button>
            </Grid>
          </Grid>
          <Typography align="center" style={{ marginTop: '10px' }}>
            Role:
            <Button onClick={() => setRole('customer')} color={role === 'customer' ? 'primary' : 'inherit'}>Customer</Button>
            <Button onClick={() => setRole('vendor')} color={role === 'vendor' ? 'primary' : 'inherit'}>Vendor</Button>
          </Typography>
        </Container>
      );
    }

    // Product Listing Component
    function Products({ userRole, user }) {
      const [products, setProducts] = useState([]);
      const [search, setSearch] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchProducts = async () => {
          setLoading(true);
          const snapshot = await db.collection('products')
            .where('title', '>=', search)
            .where('title', '<=', search + '\uf8ff')
            .get();
          const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setProducts(productsData);
          setLoading(false);
        };
        fetchProducts();
      }, [search]);

      const addProduct = async () => {
        const title = prompt('Product Title:');
        const description = prompt('Description:');
        const price = prompt('Price:');
        if (title && description && price) {
          await db.collection('products').add({
            title,
            description,
            price: parseFloat(price),
            vendorId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          fetchProducts();
        }
      };

      return (
        <div>
          <TextField
            label="Search Products"
            value={search}
            onChange={e => setSearch(e.target.value)}
            InputProps={{
              endAdornment: (
                <InputAdornment position="end">
                  <SearchIcon />
                </InputAdornment>
              )
            }}
            fullWidth
            margin="normal"
          />
          {userRole === 'vendor' && (
            <Button variant="contained" color="primary" onClick={addProduct} style={{ marginBottom: '20px' }}>
              Add Product
            </Button>
          )}
          {loading ? (
            <CircularProgress style={{ display: 'block', margin: '20px auto' }} />
          ) : (
            <Grid container spacing={3}>
              {products.map(product => (
                <Grid item xs={12} sm={6} md={4} key={product.id}>
                  <Card>
                    <CardContent>
                      <Typography variant="h6">{product.title}</Typography>
                      <Typography>{product.description}</Typography>
                      <Typography color="textSecondary">${product.price}</Typography>
                    </CardContent>
                    <CardActions>
                      <Button size="small" color="primary">View Details</Button>
                    </CardActions>
                  </Card>
                </Grid>
              ))}
            </Grid>
          )}
        </div>
      );
    }

    // Profile Component
    function Profile({ user, userRole }) {
      const [anchorEl, setAnchorEl] = useState(null);
      const [profileData, setProfileData] = useState({ name: '', bio: '' });

      useEffect(() => {
        if (user) {
          db.collection('users').doc(user.uid).onSnapshot(doc => {
            setProfileData(doc.data() || { name: '', bio: '' });
          });
        }
      }, [user]);

      const handleProfileUpdate = async () => {
        const name = prompt('Enter your name:', profileData.name);
        const bio = prompt('Enter your bio:', profileData.bio);
        if (name && bio) {
          await db.collection('users').doc(user.uid).update({ name, bio });
        }
      };

      return (
        <div>
          <IconButton onClick={e => setAnchorEl(e.currentTarget)}>
            <Avatar>{user.email[0]}</Avatar>
          </IconButton>
          <Menu
            anchorEl={anchorEl}
            open={Boolean(anchorEl)}
            onClose={() => setAnchorEl(null)}
          >
            <MenuItem>
              <Typography>{profileData.name || user.email}</Typography>
            </MenuItem>
            <MenuItem>
              <Typography variant="body2" color="textSecondary">{profileData.bio || 'No bio yet'}</Typography>
            </MenuItem>
            <MenuItem onClick={handleProfileUpdate}>Edit Profile</MenuItem>
            <MenuItem onClick={() => auth.signOut()}>Logout</MenuItem>
          </Menu>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [userRole, setUserRole] = useState('customer');

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(user => setUser(user));
        return () => unsubscribe();
      }, []);

      return (
        <div>
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" style={{ flexGrow: 1 }}>Multivendor Marketplace</Typography>
              {user && <Profile user={user} userRole={userRole} />}
            </Toolbar>
          </AppBar>
          <Container style={{ marginTop: '20px' }}>
            {!user ? (
              <Auth setUserRole={setUserRole} />
            ) : (
              <Products userRole={userRole} user={user} />
            )}
          </Container>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>