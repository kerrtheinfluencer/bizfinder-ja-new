<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BizFinder JA - Multivendor Platform</title>
  <!-- Firebase SDK v9.6.1 (consistent with provided files) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f4f4f4;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      font-size: 24px;
    }
    .search-bar {
      display: flex;
      align-items: center;
    }
    #search-input {
      padding: 8px;
      width: 200px;
      border: none;
      border-radius: 4px 0 0 4px;
    }
    #search-btn {
      padding: 8px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }
    #search-btn:hover {
      background-color: #2980b9;
    }
    #nav-buttons button {
      padding: 8px 12px;
      margin-left: 10px;
      background-color: #ecf0f1;
      color: #2c3e50;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #nav-buttons button:hover {
      background-color: #bdc3c7;
    }
    main {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .section {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 15px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    input, textarea, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      padding: 10px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #2980b9;
    }
    .error {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 5px;
    }
    .store-item, .product-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .store-item:last-child, .product-item:last-child {
      border-bottom: none;
    }
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-bar, #nav-buttons {
        width: 100%;
        margin-top: 10px;
      }
      #search-input {
        width: calc(100% - 60px);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>BizFinder JA</h1>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search stores...">
      <button id="search-btn">Search</button>
    </div>
    <div id="nav-buttons">
      <!-- Dynamically populated based on auth state -->
    </div>
  </header>
  <main>
    <div id="landing" class="section" style="display: block;">
      <h2>Welcome to BizFinder JA</h2>
      <p>Discover local businesses and explore their products.</p>
    </div>
    <div id="login-form" class="section" style="display: none;">
      <h2>Login</h2>
      <form id="login-form-element">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" minlength="6" required>
        <button type="submit">Login</button>
        <p id="login-error" class="error"></p>
      </form>
    </div>
    <div id="signup-form" class="section" style="display: none;">
      <h2>Sign Up</h2>
      <form id="signup-form-element">
        <input type="text" id="signup-name" placeholder="Full Name" pattern="[A-Za-z ]{2,}" title="Name must be at least 2 letters" required>
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="password" id="signup-password" placeholder="Password (min 6 chars)" minlength="6" required>
        <select id="user-type" required>
          <option value="" disabled selected>Select User Type</option>
          <option value="customer">Customer</option>
          <option value="business">Business</option>
        </select>
        <button type="submit">Sign Up</button>
        <p id="signup-error" class="error"></p>
      </form>
    </div>
    <div id="dashboard" class="section" style="display: none;">
      <!-- Dynamically populated based on user type -->
    </div>
    <div id="search" class="section" style="display: none;">
      <h2>Search Results</h2>
      <div id="search-results"></div>
    </div>
    <div id="store-page" class="section" style="display: none;">
      <button id="back-to-search">Back to Search</button>
      <h2 id="store-name"></h2>
      <p id="store-description"></p>
      <h3>Products</h3>
      <div id="store-products"></div>
    </div>
  </main>

  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBPk2blB_5XsrF8Biw01GxQjtY-A8RMeBI",
      authDomain: "bizfinder-7b1b6.firebaseapp.com",
      projectId: "bizfinder-7b1b6",
      storageBucket: "bizfinder-7b1b6.firebasestorage.app",
      messagingSenderId: "953228556886",
      appId: "1:953228556886:web:8c589d5a59a75045c959f7",
      measurementId: "G-SW2BZ8LD07"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Utility Functions
    function showSection(sectionId) {
      const sections = ['landing', 'login-form', 'signup-form', 'dashboard', 'search', 'store-page'];
      sections.forEach(id => {
        document.getElementById(id).style.display = id === sectionId ? 'block' : 'none';
      });
    }

    function showError(elementId, message) {
      document.getElementById(elementId).textContent = message;
    }

    function clearErrors() {
      document.getElementById('login-error').textContent = '';
      document.getElementById('signup-error').textContent = '';
    }

    // Authentication State Listener
    auth.onAuthStateChanged(user => {
      const navButtons = document.getElementById('nav-buttons');
      if (user) {
        navButtons.innerHTML = `
          <button id="dashboard-btn">Dashboard</button>
          <button id="logout-btn">Logout</button>
        `;
        document.getElementById('dashboard-btn').addEventListener('click', () => showSection('dashboard'));
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        showSection('dashboard');
        loadDashboard(user);
      } else {
        navButtons.innerHTML = `
          <button id="login-btn">Login</button>
          <button id="signup-btn">Sign Up</button>
        `;
        document.getElementById('login-btn').addEventListener('click', () => showSection('login-form'));
        document.getElementById('signup-btn').addEventListener('click', () => showSection('signup-form'));
        showSection('landing');
      }
    });

    // Load Dashboard Based on User Type
    async function loadDashboard(user) {
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) throw new Error('User data not found');
        const userData = userDoc.data();
        const dashboard = document.getElementById('dashboard');
        if (userData.type === 'business') {
          dashboard.innerHTML = `
            <h2>Business Dashboard</h2>
            <p>Welcome, ${userData.name}</p>
            <button id="add-product-btn">Add Product</button>
            <div id="product-form" style="display: none;">
              <h3>Add New Product</h3>
              <form id="product-form-element">
                <input type="text" id="product-name" placeholder="Product Name" required>
                <textarea id="product-desc" placeholder="Description" required></textarea>
                <input type="number" id="product-price" placeholder="Price" min="0" step="0.01" required>
                <button type="submit">Add Product</button>
                <p id="product-error" class="error"></p>
              </form>
            </div>
            <h3>Your Products</h3>
            <div id="business-products"></div>
          `;
          document.getElementById('add-product-btn').addEventListener('click', () => {
            document.getElementById('product-form').style.display = 'block';
          });
          document.getElementById('product-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('product-name').value;
            const desc = document.getElementById('product-desc').value;
            const price = parseFloat(document.getElementById('product-price').value);
            try {
              await db.collection('stores').doc(user.uid).collection('products').add({
                name,
                description: desc,
                price,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              document.getElementById('product-form').style.display = 'none';
              loadBusinessProducts(user.uid);
            } catch (error) {
              showError('product-error', error.message);
            }
          });
          loadBusinessProducts(user.uid);
        } else {
          dashboard.innerHTML = `
            <h2>Customer Dashboard</h2>
            <p>Welcome, ${userData.name}</p>
            <p>Start searching for stores using the search bar above!</p>
          `;
        }
      } catch (error) {
        document.getElementById('dashboard').innerHTML = `<p class="error">Error loading dashboard: ${error.message}</p>`;
      }
    }

    async function loadBusinessProducts(businessId) {
      const productsDiv = document.getElementById('business-products');
      productsDiv.innerHTML = 'Loading products...';
      try {
        const snapshot = await db.collection('stores').doc(businessId).collection('products').get();
        productsDiv.innerHTML = '';
        if (snapshot.empty) {
          productsDiv.textContent = 'No products yet.';
          return;
        }
        snapshot.forEach(doc => {
          const product = doc.data();
          const productElem = document.createElement('div');
          productElem.className = 'product-item';
          productElem.innerHTML = `<h4>${product.name}</h4><p>${product.description}</p><p>Price: $${product.price.toFixed(2)}</p>`;
          productsDiv.appendChild(productElem);
        });
      } catch (error) {
        productsDiv.innerHTML = `<p class="error">Error loading products: ${error.message}</p>`;
      }
    }

    // Search Functionality
    document.getElementById('search-btn').addEventListener('click', async () => {
      const query = document.getElementById('search-input').value.trim();
      if (query.length < 2) {
        alert('Please enter at least 2 characters to search.');
        return;
      }
      showSection('search');
      await performSearch(query);
    });

    async function performSearch(query) {
      const resultsDiv = document.getElementById('search-results');
      resultsDiv.innerHTML = 'Searching...';
      try {
        const snapshot = await db.collection('stores')
          .where('name', '>=', query)
          .where('name', '<=', query + '\uf8ff')
          .limit(10)
          .get();
        resultsDiv.innerHTML = '';
        if (snapshot.empty) {
          resultsDiv.textContent = 'No stores found.';
          return;
        }
        snapshot.forEach(doc => {
          const store = doc.data();
          const storeElem = document.createElement('div');
          storeElem.className = 'store-item';
          storeElem.innerHTML = `
            <h3>${store.name}</h3>
            <p>${store.description || 'No description available'}</p>
            <button class="view-store" data-id="${doc.id}">View Store</button>
          `;
          resultsDiv.appendChild(storeElem);
        });
        document.querySelectorAll('.view-store').forEach(btn => {
          btn.addEventListener('click', () => showStorePage(btn.getAttribute('data-id')));
        });
      } catch (error) {
        resultsDiv.innerHTML = `<p class="error">Error searching stores: ${error.message}</p>`;
      }
    }

    // Store Page
    async function showStorePage(storeId) {
      showSection('store-page');
      const storeName = document.getElementById('store-name');
      const storeDesc = document.getElementById('store-description');
      const productsDiv = document.getElementById('store-products');
      storeName.textContent = 'Loading...';
      storeDesc.textContent = '';
      productsDiv.innerHTML = '';
      try {
        const storeDoc = await db.collection('stores').doc(storeId).get();
        if (!storeDoc.exists) throw new Error('Store not found');
        const store = storeDoc.data();
        storeName.textContent = store.name;
        storeDesc.textContent = store.description || 'No description available';
        const productsSnapshot = await db.collection('stores').doc(storeId).collection('products').get();
        if (productsSnapshot.empty) {
          productsDiv.textContent = 'No products available.';
        } else {
          productsSnapshot.forEach(doc => {
            const product = doc.data();
            const productElem = document.createElement('div');
            productElem.className = 'product-item';
            productElem.innerHTML = `
              <h4>${product.name}</h4>
              <p>${product.description}</p>
              <p>Price: $${product.price.toFixed(2)}</p>
            `;
            productsDiv.appendChild(productElem);
          });
        }
      } catch (error) {
        storeName.textContent = 'Error';
        storeDesc.textContent = `Failed to load store: ${error.message}`;
      }
      document.getElementById('back-to-search').onclick = () => showSection('search');
    }

    // Login Handler
    document.getElementById('login-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        showError('login-error', error.message);
      }
    });

    // Signup Handler
    document.getElementById('signup-form-element').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const userType = document.getElementById('user-type').value;
      if (!userType) {
        showError('signup-error', 'Please select a user type.');
        return;
      }
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        await db.collection('users').doc(user.uid).set({
          name,
          email,
          type: userType,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        if (userType === 'business') {
          await db.collection('stores').doc(user.uid).set({
            name: `${name}'s Store`,
            description: 'A new store on BizFinder JA',
            ownerId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (error) {
        showError('signup-error', error.message);
      }
    });
  </script>
</body>
</html>